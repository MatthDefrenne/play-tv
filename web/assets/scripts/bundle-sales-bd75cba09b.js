!function(){function e(t,r,n){function i(a,s){if(!r[a]){if(!t[a]){var d="function"==typeof require&&require;if(!s&&d)return d(a,!0);if(o)return o(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[a]={exports:{}};t[a][0].call(l.exports,function(e){var r=t[a][1][e];return i(r||e)},l,l.exports,e,t,r,n)}return r[a].exports}for(var o="function"==typeof require&&require,a=0;a<n.length;a++)i(n[a]);return i}return e}()({1:[function(e,t,r){t.exports=window.ptv=window.ptv||{}},{}],2:[function(e,t,r){var n=e("./_global-legacy"),i=e("./views/sales/product"),o=e("./views/order/index"),a=e("./views/order/confirm");n.Collapse.initialize(),new i,new o,new a},{"./_global-legacy":1,"./views/order/confirm":5,"./views/order/index":6,"./views/sales/product":7}],3:[function(e,t,r){var n=window.Backbone;t.exports=n.View.extend({elements:null,constructor:function(){n.View.apply(this,arguments)},storeElements:function(){var e=this.elements;null!==e&&"object"==typeof e&&Object.keys(e).forEach(function(t){this["$"+t]=this.$(e[t]),this[t]=this.$(e[t])[0]},this)},close:function(){this.stopListening(),this.undelegateEvents()}})},{}],4:[function(e,t,r){var n=e("./../base");t.exports=n.extend({bind:function(){return this.model.set("number",this.$('input[data-name="card-number"]').val()),this.model.set("exp_month",this.$('input[data-name="card-expiry-month"]').val()),this.model.set("exp_year",this.$('input[data-name="card-expiry-year"]').val()),this.model.set("cvc",this.$('input[data-name="card-cvc"]').val()),this.$('input[data-name="card-holdername"]').length>0&&this.model.set("cardholder",this.$('input[data-name="card-holdername"]').val()),this}})},{"./../base":3}],5:[function(e,t,r){var n=e("./../base"),i=e("browser-js");t.exports=n.extend({el:".pmd-js-OrderConfirm",events:{"click .pmd-js-OrderConfirm-link":"handleLinkClick"},handleLinkClick:function(e){e.preventDefault(),i.isPoppedUp()?window.close():i.visit(e.currentTarget.getAttribute("href"))}})},{"./../base":3,"browser-js":8}],6:[function(e,t,r){var n=e("./../base"),i=e("./../../_global-legacy"),o=e("./../credit-card/index");t.exports=n.extend({el:".ptv-js-Order",events:{"submit .ptv-js-Order-loginForm":"submitLogin","submit .ptv-js-Order-registerForm":"submitRegister","submit .ptv-js-OrderPayment-form":"submitPayment","click .ptv-js-OrderPayment-modify":"modifyPayment","keyup .ptv-js-Order-cardNumber":"onChangeCardNumber","click .ptv-js-DialogFacebook":"onDialogFacebook","click .ptv-js-OrderAccount-forgotPassword":"onForgotPassword"},creditCardModel:void 0,creditCardView:void 0,brandDetection:void 0,initialize:function(){this.creditCardModel=new i.Models.CreditCard,this.creditCardView=new o({model:this.creditCardModel,el:this.$(".ptv-js-Order-payment")}),this.brandDetection=new BrandDetection,this.$(".ptv-js-OrderPayment-cvc").qtip({style:{classes:"qtip-rounded qtip-tipsy"},position:{my:"left center",at:"right center"}});var e=this;this.$(".pmd-OrderPaymentTabs").easytabs({animate:!1,updateHash:!1}).bind("easytabs:after",function(t,r){var n=r.data("gateway");e.$(".pmd-OrderPaymentAlert").find(".ptv-Alert").removeClass("ptv-Alert--active"),e.$(".pmd-OrderPaymentAlert").find('.ptv-Alert[data-gateway="'+n+'"]').addClass("ptv-Alert--active")})},onLoginSuccess:function(){window.location.reload()},submitLogin:function(e){e.preventDefault();var t=this,r=$(e.target).serialize(),n=Ladda.create(this.$(".ptv-js-Order-loginAction").get(0));this.resetAccountAlert(),n.start(),$.post("/connexion/",r).done(function(){t.onLoginSuccess()}).fail(function(e){var r=JSON.parse(e.responseText);t.resetAccountAlert().renderAccountAlert(r),n.stop()})},submitRegister:function(e){e.preventDefault();var t=this,r=Ladda.create(this.$(".ptv-js-Order-registerAction").get(0));return this.resetAccountAlert(),r.start(),this.validateAccount().done(function(){t.onLoginSuccess()}).fail(function(){r.stop()}),!1},submitPayment:function(e){var t=this,r=$(e.target),n=r.find('input[name="token"]').length>0,i=Ladda.create(this.$(".ptv-js-Order-paymentAction").get(0));return i.start(),"true"===r.attr("data-initialized")?this.validateCgv():n?!0:(e.preventDefault(),this.validatePayment().done(function(){t.creditCardModel.createToken("0000","EUR",function(e,n){if(e)console.log("error");else{var i=$("<input>").attr({type:"hidden",name:"token",value:n.token});t.$(".ptv-js-OrderPayment-form").append(i),r.submit()}})}).fail(function(){i.stop()}),!1)},validateCgv:function(){var e=this.isCgvChecked();if(!e){var t={cgv:"Vous devez accepter les Conditions Générales d'utilisation."};return this.resetPaymentAlert().renderPaymentAlert(t),!1}return!0},validatePayment:function(){var e=$.Deferred(),t=this.$(".ptv-js-OrderPayment-alert"),r=this.isCgvChecked();if(t.empty(),this.creditCardView.bind(),this.creditCardModel.isValid()&&r)this.resetPaymentAlert(),e.resolve();else{var n={};r||(n.cgv="Vous devez accepter les Conditions Générales d'utilisation."),n=_.extend(n,this.creditCardModel.validationError),this.resetPaymentAlert().renderPaymentAlert(n),e.reject()}return e.promise()},modifyPayment:function(e){e.preventDefault();var t=this.$(".ptv-js-OrderPayment-form"),r=this.$(".ptv-js-Order-creditCard");r.removeClass("pmd-Order-creditCard--disabled"),t.removeAttr("data-initialized"),t.find("input").removeAttr("placeholder").removeAttr("disabled"),t.find("input").first().trigger("focus")},isCgvChecked:function(){return 0===this.$(".ptv-js-OrderPayment-cgv").length?!0:this.$(".ptv-js-OrderPayment-cgv").is(":checked")},validateAccount:function(){var e=this,t=this.$(".ptv-js-Order-registerForm").serializeArray(),r=$.post("/commande/inscription/",t);return r.fail(function(t){var r=JSON.parse(t.responseText);e.resetAccountAlert().renderAccountAlert(r)}).done(function(){e.resetAccountAlert()}),r},resetPaymentAlert:function(){var e=this.$(".ptv-js-OrderPayment-alert"),t=this.$(".ptv-js-OrderPayment-form");return e.empty().removeClass("ptv-Alert--error").removeClass("ptv-Alert--active"),t.find("input").removeClass("pmd-Input--error"),this},resetAccountAlert:function(){var e=this.$(".ptv-js-OrderAccount-alert");return e.empty().removeClass("ptv-Alert--error").removeClass("ptv-Alert--active"),this},renderPaymentAlert:function(e){var t=this.$(".ptv-js-OrderPayment-alert"),r=this.$(".ptv-js-OrderPayment-form");_.each(e,function(e){t.append($("<li>").text(e))}),t.addClass("ptv-Alert--error").addClass("ptv-Alert--active"),void 0===e.type&&void 0===e.number||r.find('input[data-name="card-number"]').addClass("pmd-Input--error"),void 0!==e.expiry&&r.find('input[data-name="card-expiry-month"], input[data-name="card-expiry-year"]').addClass("pmd-Input--error"),void 0!==e.cvc&&r.find('input[data-name="card-cvc"]').addClass("pmd-Input--error")},renderAccountAlert:function(e){var t=this.$(".ptv-js-OrderAccount-alert");_.each(e,function(e){t.append($("<li>").html(e))}),t.addClass("ptv-Alert--error").addClass("ptv-Alert--active")},onChangeCardNumber:function(e){var t=$(e.target),r=t.val(),n=this.$(".ptv-js-Order-creditCard"),i=this.brandDetection.detect(r);"unknown"!==i?n.filter('[data-brand!="'+i+'"]').addClass("pmd-Order-creditCard--disabled"):n.removeClass("pmd-Order-creditCard--disabled")},onDialogFacebook:function(e){var t=this,r=function(e){e&&"connected"===e.status?FB.api("/me",{fields:"id,first_name,last_name,gender,email"},function(r){t.handleOauthFacebookFlow(r,e.authResponse)}):_gaq.push(["_trackEvent","ACCOUNT","FACEBOOK","abort"])};FB.login(r,{scope:window.facebookScope.join(",")}),_gaq.push(["_trackEvent","ACCOUNT","FACEBOOK","click"]),e.preventDefault()},handleOauthFacebookFlow:function(e,t){var r=this;_.assign(e,t),$.ajax({url:"/oauth/facebook/",type:"post",data:e}).fail(function(){}).done(function(e){$.colorbox.close(),r.onLoginSuccess();var t=e||void 0;"undefined"!=typeof t.flow&&_gaq.push(["_trackEvent","ACCOUNT","FACEBOOK",t.flow])})},onForgotPassword:function(e){return e.preventDefault(),i.Events.Main.trigger("flow:forgotPassword",{src:"order"}),!1}})},{"./../../_global-legacy":1,"./../base":3,"./../credit-card/index":4}],7:[function(e,t,r){var n=e("./../base");t.exports=n.extend({el:".pmd-js-SalesProduct",events:{"click .pmd-js-SalesProduct-button":"handleButton","click .pmd-js-SalesProduct-link":"handleLink"},handleButton:function(e){e.preventDefault();var t=$(e.currentTarget).data("cart-url");this.goTo(t)},handleLink:function(e){e.preventDefault(),window.parent.$.colorbox.fromLink=!0,window.parent.$.colorbox.close()},goTo:function(e){window.top.location.href=e}})},{"./../base":3}],8:[function(e,t,r){!function(n,i){"object"==typeof r?t.exports=i(e("browser-js")):n.Browser=i(n.Browser)}(this,function(){return{visit:function(e,t){var t=t||!1;t?window.top.location.href=e:window.location.href=e},reload:function(e){var e=e||!1;document.location.reload(e)},goBack:function(){history.back(-1)},newWindow:function(e){window.open(e,"_blank")},newTab:function(e){this.newWindow(e)},newPopup:function(e){if("undefined"==typeof e||"undefined"==typeof e.url)throw new Error("You must define at least an url.");var t={};t.url=e.url,t.name=e.name||"defaultPopup",t.options=e.options||{},"undefined"==typeof t.options.width&&(t.options.width=640),"undefined"==typeof t.options.height&&(t.options.height=480);var r="";for(var n in t.options)t.options.hasOwnProperty(n)&&(r+=n+"="+t.options[n]+",");return t.options=r.substr(0,r.length-1),window.open(t.url,e.name,t.options)},getParentUrl:function(){var e=void 0;return this.isEmbedded()&&(e=document.referrer),e},getParentHostname:function(){var e=this.getParentUrl(),t=e;if(void 0!==e){var r=document.createElement("a");r.href=e,t=r.hostname}return t},redirectToOriginal:function(){window.top.location.href=window.location.href},preventEmbedded:function(){this.isEmbedded()&&this.redirectToOriginal()},isEmbedded:function(){return window.top!==window.self},isPoppedUp:function(){return!(null===window.opener||void 0===window.opener)}}})},{"browser-js":8}]},{},[2]);